import{r as m,j as t}from"./index-DYK0myhA.js";function ve({api:B,settings:f,onConfirm:U,translations:ie,styles:le}){const[_,G]=m.useState([]),[J,Y]=m.useState(!1),[O,c]=m.useState(""),[K,L]=m.useState(""),[N,D]=m.useState([]),[b,I]=m.useState([]),[x,X]=m.useState(""),[w,Z]=m.useState(""),[R,ee]=m.useState(""),[$,ce]=m.useState(!1),[te,ne]=m.useState(""),[oe,H]=m.useState(!1),[V,re]=m.useState("Mark, Qty, Profile"),q=m.useRef(null),E=m.useRef(null),j=ie||{},u=le||{};async function de(e){return new Promise((n,d)=>{const l=new FileReader;l.onload=()=>{const s=String(l.result||""),r=s.indexOf(",");n(r>=0?s.slice(r+1):s)},l.onerror=d,l.readAsDataURL(e)})}async function se(e){if(!e||!e.length)return;const n=e[0];if(G([n]),n.type.startsWith("image/")){const d=new FileReader;d.onload=l=>{var s;ne(((s=l.target)==null?void 0:s.result)||"")},d.readAsDataURL(n)}}async function ue(e){var g,C,p,y,k,h,S,T,A,o;const n=V.trim(),l=`You are an expert at reading logistics transport sheets and fabrication lists.

${n?`Extract ONLY these columns in this exact order: ${n}. If column names are not visible in the image, use column positions (1st column from left = ${((g=n.split(",")[0])==null?void 0:g.trim())||"1"}, 2nd column = ${((C=n.split(",")[1])==null?void 0:C.trim())||"2"}, etc).`:"Extract all visible columns."}

Return data as TSV (tab-separated values) format with headers in the first row.
Keep the EXACT ORIGINAL ORDER of rows as they appear in the image (top to bottom).
If you cannot read a cell clearly, put "???" there.
Do not skip any rows.
Do not add extra rows.

${(f==null?void 0:f.ocrPrompt)||""}`,s=new AbortController,r=setTimeout(()=>s.abort(),3e4);try{if(f!=null&&f.ocrWebhookUrl){const a=await fetch(f.ocrWebhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:f.ocrSecret,file:{name:((p=_[0])==null?void 0:p.name)||"image.jpg",type:((y=_[0])==null?void 0:y.type)||"image/jpeg",data:e},prompt:l}),signal:s.signal});if(!a.ok)throw new Error(`Webhook viga: ${a.status}`);const i=await a.json();if(!i.ok)throw new Error(i.error||"OCR eba√µnnestus");return i.text||""}if(f!=null&&f.openaiApiKey){const a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f.openaiApiKey}`},body:JSON.stringify({model:"gpt-4o",messages:[{role:"user",content:[{type:"text",text:l},{type:"image_url",image_url:{url:`data:${((k=_[0])==null?void 0:k.type)||"image/jpeg"};base64,${e}`}}]}],max_tokens:2e3}),signal:s.signal});if(!a.ok){const W=await a.json().catch(()=>({}));throw new Error(`OpenAI API viga: ${a.status} - ${((h=W.error)==null?void 0:h.message)||a.statusText}`)}const i=await a.json();let v="";if((A=(T=(S=i.choices)==null?void 0:S[0])==null?void 0:T.message)!=null&&A.content?v=i.choices[0].message.content:i.output_text?v=i.output_text:Array.isArray(i.output)&&((o=i.output[0])!=null&&o.content)&&(v=i.output[0].content),!v)throw new Error("OpenAI API tagastas t√ºhja vastuse");return v}throw new Error("OCR pole seadistatud! Lisa webhook URL v√µi OpenAI API v√µti seadetes.")}finally{clearTimeout(r)}}async function fe(){try{if(c(""),Y(!0),!_.length){K.trim()?c("‚úì Tekst on kleebitud. Vajuta 'Parsi tabelisse'."):c("‚ùå Pole faile ega teksti.");return}if(!(f!=null&&f.ocrWebhookUrl)&&!(f!=null&&f.openaiApiKey)){c("‚ùå OCR pole seadistatud! Lisa webhook URL v√µi OpenAI API v√µti seadetes.");return}if(!V.trim()){c("‚ùå M√§√§ra esmalt veerud!");return}c(j.usingOcr||"üîç OCR...");const e=await de(_[0]),n=await ue(e);L(n),c("‚úÖ OCR valmis! Vajuta 'Parsi tabelisse'.")}catch(e){c("‚ùå Viga: "+((e==null?void 0:e.message)||String(e)))}finally{Y(!1)}}function pe(e){const n=e.split(/\r?\n/).map(o=>o.replace(/\t+/g,"  ").trim()).filter(Boolean);if(n.length===0){D([]),I([]),c("‚ùå T√ºhjus.");return}let d=0,l=-1;for(let o=0;o<Math.min(n.length,20);o++){const a=n[o].split(/\s{2,}|\t/).filter(Boolean),i=/\b(component|mark|qty|pcs|kogus|profile|length|weight|komponent)\b/i.test(n[o])?3:0,v=a.length+i;v>l&&(l=v,d=o)}const s=n[d].split(/\s{2,}|\t/).map(o=>he(o)).filter(Boolean),r=s.length>0?s:n[0].split(/\s{2,}|\t/).map((o,a)=>"Col"+(a+1)),g=[];let C=0;for(let o=0;o<n.length;o++){if(o===d)continue;const a=n[o].split(/\s{2,}|\t/);if(a.length<2){C++;continue}const i={};let v=!1,W=!1;for(let F=0;F<Math.min(a.length,r.length);F++){const Q=a[F].trim();i[r[F]]=Q,Q&&(v=!0),Q==="???"&&(W=!0)}W?(i._warning="‚ö†Ô∏è OCR ei suutnud lugeda",i._confidence=.5):a.length<r.length?(i._warning="‚ö†Ô∏è Puudulikud veerud",i._confidence=.6):v?i._confidence=.95:(i._warning="‚ö†Ô∏è T√ºhi rida",i._confidence=.3),g.push(i)}D(r),I(g);const p=r.map(o=>o.toLowerCase()),y=p.findIndex(o=>/\b(mark|component|item|part|komponent)\b/.test(o)),k=p.findIndex(o=>/\b(qty|pcs|kogus|tk|amount)\b/.test(o)),h=r.findIndex((o,a)=>a!==(y>=0?y:0)&&a!==(k>=0?k:r.length-1));X(r[y>=0?y:0]||""),Z(r[k>=0?k:r.length-1]||""),ee(r[h>=0?h:Math.min(2,r.length-1)]||"");const S=C>0?` ‚ö†Ô∏è ${C} rida j√§eti vahele.`:"",T=g.filter(o=>{var a;return(a=o._warning)==null?void 0:a.includes("ei suutnud")}).length,A=T>0?` ‚ö†Ô∏è ${T} lahtrit ???`:"";c(`‚úì Tabel valmis: ${g.length} rida.${S}${A}`)}function he(e){const n=e.replace(/\s+/g," ").trim();return n?n.replace(/No\./i,"No").replace(/Amount/i,"Qty").replace(/Pieces/i,"Pcs").replace(/Quantity/i,"Qty").replace(/[^\w\s.-]/g,"").trim():""}function me(e,n,d){I(l=>{var r;const s=[...l];return s[e]={...s[e],[n]:d},d&&d!=="???"&&((r=s[e]._warning)!=null&&r.includes("ei suutnud"))&&(delete s[e]._warning,s[e]._confidence=.95),s})}function ge(){const e={_confidence:1};e[x]="",e[w]="",$&&R&&(e[R]=""),I(n=>[...n,e])}function xe(e){I(n=>n.filter((d,l)=>l!==e))}async function be(){if(!x||!b.length){c("‚ùå Parsi esmalt tabel!");return}try{H(!0),c("üîç Otsin mudelist...");const e=B==null?void 0:B.viewer,n=b.map(p=>String(p[x]||"").trim()).filter(Boolean),d=[...new Set(n)],l=await(e==null?void 0:e.getObjects());if(!Array.isArray(l)){c("‚ùå API viga"),H(!1);return}const s=new Set;for(const p of l){const y=String(p.modelId),k=(p.objects||[]).map(h=>Number(h==null?void 0:h.id)).filter(h=>Number.isFinite(h));try{const h=await B.viewer.getObjectProperties(y,k);for(const S of h){const T=Array.isArray(S==null?void 0:S.properties)?S.properties:[];for(const A of T)for(const o of(A==null?void 0:A.properties)??[])if(/assembly[\/\s]?cast[_\s]?unit[_\s]?mark|^mark$|block/i.test(String(o==null?void 0:o.name))){const a=String((o==null?void 0:o.value)||(o==null?void 0:o.displayValue)||"").trim();d.some(i=>i.toLowerCase()===a.toLowerCase())&&s.add(a)}}}catch(h){console.warn(`Model ${y} error:`,h)}}const r=b.map(p=>{const y=String(p[x]||"").trim(),k=Array.from(s).some(h=>h.toLowerCase()===y.toLowerCase());return{...p,_foundInModel:k}});I(r);const g=r.filter(p=>p._foundInModel===!0).length,C=r.filter(p=>p._foundInModel===!1).length;c(`‚úì ${g} ‚úÖ leitud, ${C} ‚ùå ei leitud.`)}catch(e){c("‚ùå Viga: "+((e==null?void 0:e.message)||String(e)))}finally{H(!1)}}const ye=b.length,P=b.filter(e=>e._warning).length,M=b.filter(e=>e._foundInModel===!1).length,ae=m.useMemo(()=>{const e=[x,w];return $&&R&&R!==x&&R!==w&&e.push(R),e.filter(Boolean)},[x,w,R,$]),z=m.useMemo(()=>{const e=[];if(!x||!w)return e;for(const n of b){const d=String(n[x]||"").trim();if(!d)continue;const l=String(n[w]||"").replace(",",".").trim(),s=Math.max(1,Math.floor(Number(l)||0));for(let r=0;r<s;r++)e.push(d)}return e},[b,x,w]);function we(){if(!b.length){c("‚ùå Tabel on t√ºhi.");return}if(!x||!w){c("‚ùå Vali Mark ja Kogus veerud.");return}if(P>0){c(`‚ö†Ô∏è ${P} hoiatust. Paranda!`);return}if(M>0){c(`‚ö†Ô∏è ${M} ei leitud mudelist!`);return}U&&U(z,b,x,w),c("‚úÖ Kinnitatud: "+z.length+" kirjet.")}function je(){L(`Mark	Qty	Profile
B-101	3	HEA 200
C-205	2	HEB 300
PL-42	5	FL 10x200
BR-88	4	L 100x100x10`),re("Mark, Qty, Profile"),c("üìã N√§idis laaditud.")}return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[t.jsxs("div",{children:[t.jsxs("label",{style:u.labelTop,children:["üìÅ ",j.uploadFiles||"Fail"]}),t.jsx("input",{ref:q,type:"file",accept:"image/*,application/pdf",onChange:e=>se(e.target.files),style:{fontSize:12,width:"100%"}})]}),t.jsxs("div",{children:[t.jsx("label",{style:u.labelTop,children:"üì∑ Pildista"}),t.jsx("input",{ref:E,type:"file",accept:"image/*",capture:"environment",onChange:e=>se(e.target.files),style:{display:"none"}}),t.jsx("button",{style:{...u.btn,width:"100%",background:"#d1fae5",borderColor:"#10b981"},onClick:()=>{var e;return(e=E.current)==null?void 0:e.click()},children:"üì∑ Kaamera"})]})]}),te&&t.jsx("div",{children:t.jsx("img",{src:te,alt:"Preview",style:{maxWidth:"100%",maxHeight:150,borderRadius:6,border:"1px solid #e5e7eb"}})}),t.jsxs("div",{children:[t.jsx("label",{style:u.labelTop,children:j.targetColumns||"Veerud"}),t.jsx("input",{value:V,onChange:e=>re(e.target.value),placeholder:"Mark, Qty, Profile",style:u.input}),t.jsx("div",{style:{fontSize:11,opacity:.6,marginTop:2},children:j.targetColumnsHint||"Kui veeru nimesid pole, kasuta numbreid: '1, 2, 3'"})]}),t.jsxs("div",{children:[t.jsx("label",{style:u.labelTop,children:j.orPasteText||"V√µi kleebi tekst"}),t.jsx("textarea",{style:{...u.textarea,height:100},value:K,onChange:e=>L(e.target.value),placeholder:j.pasteHint||"Tekst..."})]}),t.jsxs("div",{style:u.controls,children:[t.jsx("button",{style:{...u.btn,background:"#10b981",color:"#fff",borderColor:"#10b981"},disabled:J,onClick:fe,children:J?"‚è≥":j.runOcr||"üîç OCR"}),t.jsx("button",{style:u.btnGhost,onClick:je,children:"üìã N√§idis"}),t.jsx("button",{style:u.btn,onClick:()=>{if(!K.trim()){c("‚ùå Pole teksti.");return}pe(K)},children:j.parseToTable||"‚ö° Parsi"}),t.jsx("button",{style:u.btnGhost,onClick:()=>{L(""),I([]),D([]),G([]),ne(""),q.current&&(q.current.value=""),E.current&&(E.current.value=""),c("üóëÔ∏è T√ºhjendatud.")},children:"üóëÔ∏è"})]}),O&&t.jsx("div",{style:{...u.note,...O.includes("‚ùå")?{background:"#ffebee",borderColor:"#ef9a9a"}:O.includes("‚úÖ")||O.includes("‚úì")?{background:"#e8f5e9",borderColor:"#a5d6a7"}:{}},children:O})]}),b.length>0&&t.jsxs("div",{style:{border:"1px solid #edf0f4",borderRadius:8,padding:12,background:"#fafbfc"},children:[t.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8,flexWrap:"wrap",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:11,opacity:.7},children:j.markColumn||"Mark"}),t.jsx("select",{value:x,onChange:e=>X(e.target.value),style:{...u.input,width:120,padding:"4px 6px"},children:N.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:11,opacity:.7},children:j.qtyColumn||"Kogus"}),t.jsx("select",{value:w,onChange:e=>Z(e.target.value),style:{...u.input,width:120,padding:"4px 6px"},children:N.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{style:{fontSize:12,display:"flex",alignItems:"center",gap:4},children:[t.jsx("input",{type:"checkbox",checked:$,onChange:e=>ce(e.target.checked)}),"3. veerg"]}),$&&t.jsx("select",{value:R,onChange:e=>ee(e.target.value),style:{...u.input,width:120,padding:"4px 6px"},children:N.filter(e=>e!==x&&e!==w).map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsx("button",{style:{...u.btn,background:"#7c3aed",color:"#fff",borderColor:"#7c3aed",marginLeft:"auto"},disabled:oe,onClick:be,children:oe?"üîç...":"üîç Otsi mudelist"})]}),t.jsxs("div",{style:{fontSize:11,opacity:.7,marginBottom:6},children:["Ridu: ",ye,P>0&&` ‚ö†Ô∏è ${P}`,M>0&&` ‚ùå ${M}`]}),t.jsx("div",{style:{overflow:"auto",maxHeight:400,border:"1px solid #e5e7eb",borderRadius:6},children:t.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:12},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{textAlign:"left",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0},children:"#"}),t.jsx("th",{style:{textAlign:"center",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0,width:40},children:"‚úì"}),ae.map(e=>t.jsx("th",{style:{textAlign:"left",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0},children:e},e)),t.jsx("th",{style:{textAlign:"center",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0,width:60},children:"-"})]})}),t.jsx("tbody",{children:b.map((e,n)=>{const d=!!e._warning,l=e._foundInModel===!1,s=e._foundInModel===!0,r=d?"#fef2f2":l?"#fff7ed":s?"#f0fdf4":n%2===0?"#fff":"#fafafa";return t.jsxs("tr",{style:{background:r},children:[t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6",textAlign:"center",opacity:.5,fontWeight:600},children:n+1}),t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6",textAlign:"center",fontSize:14},children:d?"‚ö†Ô∏è":l?"‚ùå":s?"‚úÖ":""}),ae.map(g=>t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6"},children:t.jsx("input",{value:e[g]||"",onChange:C=>me(n,g,C.target.value),style:{width:"100%",padding:"4px 6px",border:e[g]==="???"?"2px solid #f59e0b":"1px solid #e5e7eb",borderRadius:4,fontSize:12,outline:"none",background:e[g]==="???"?"#fffbeb":"transparent"},placeholder:e[g]==="???"?"???":""})},g)),t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6",textAlign:"center"},children:t.jsx("button",{onClick:()=>xe(n),style:{...u.mini,background:"#fef2f2",borderColor:"#fca5a5"},children:"‚ùå"})})]},n)})})]})}),t.jsxs("div",{style:{display:"flex",gap:6,marginTop:8,alignItems:"center"},children:[t.jsx("button",{style:u.btnGhost,onClick:ge,children:"‚ûï Lisa"}),t.jsxs("div",{style:{marginLeft:"auto",fontSize:11,opacity:.7},children:["Otsingusse: ",t.jsx("strong",{children:z.length})]})]}),t.jsxs("div",{style:{marginTop:8},children:[t.jsx("button",{style:{...u.btnPrimary,width:"100%"},onClick:we,disabled:P>0||M>0,children:j.confirmAndSearch||`‚úÖ Kinnita (${z.length})`}),(P>0||M>0)&&t.jsx("div",{style:{marginTop:4,fontSize:11,color:"#dc2626"},children:"‚ö†Ô∏è Paranda punased/oran≈æid!"})]})]})]})}export{ve as default};
