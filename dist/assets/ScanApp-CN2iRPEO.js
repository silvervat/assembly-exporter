import{r as g,j as t}from"./index-BXLpaT2m.js";function ve({api:K,settings:i,onConfirm:U,translations:ie,styles:le}){const[$,G]=g.useState([]),[J,Y]=g.useState(!1),[B,c]=g.useState(""),[L,z]=g.useState(""),[N,D]=g.useState([]),[y,P]=g.useState([]),[b,X]=g.useState(""),[j,Z]=g.useState(""),[A,ee]=g.useState(""),[E,ce]=g.useState(!1),[te,ne]=g.useState(""),[oe,H]=g.useState(!1),[V,re]=g.useState("Mark, Qty, Profile"),q=g.useRef(null),W=g.useRef(null),k=ie||{},u=le||{};async function de(e){return new Promise((n,d)=>{const l=new FileReader;l.onload=()=>{const s=String(l.result||""),r=s.indexOf(",");n(r>=0?s.slice(r+1):s)},l.onerror=d,l.readAsDataURL(e)})}async function se(e){if(!e||!e.length)return;const n=e[0];if(G([n]),n.type.startsWith("image/")){const d=new FileReader;d.onload=l=>{var s;ne(((s=l.target)==null?void 0:s.result)||"")},d.readAsDataURL(n)}}async function ue(e){var x,C,h,w,v,m,R,M,I,o,f;const n=V.trim(),l=`You are an expert at reading logistics transport sheets and fabrication lists.

${n?`Extract ONLY these columns in this exact order: ${n}. If column names are not visible in the image, use column positions (1st column from left = ${((x=n.split(",")[0])==null?void 0:x.trim())||"1"}, 2nd column = ${((C=n.split(",")[1])==null?void 0:C.trim())||"2"}, etc).`:"Extract all visible columns."}

Return data as TSV (tab-separated values) format with headers in the first row.
Keep the EXACT ORIGINAL ORDER of rows as they appear in the image (top to bottom).
If you cannot read a cell clearly, put "???" there.
Do not skip any rows.
Do not add extra rows.

${(i==null?void 0:i.ocrPrompt)||""}`,s=new AbortController,r=setTimeout(()=>s.abort(),3e4);try{if(i!=null&&i.ocrWebhookUrl&&(i!=null&&i.ocrSecret)){const a=await fetch(i.ocrWebhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:i.ocrSecret,file:{name:((h=$[0])==null?void 0:h.name)||"image.jpg",type:((w=$[0])==null?void 0:w.type)||"image/jpeg",data:e},prompt:l}),signal:s.signal});if(clearTimeout(r),!a.ok)throw new Error(`Webhook viga: ${a.status}`);const p=await a.json();if(!p.ok)throw new Error(p.error||"OCR eba√µnnestus");return p.text||""}else if(i!=null&&i.openaiApiKey){const a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${i.openaiApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o",messages:[{role:"user",content:[{type:"image_url",image_url:{url:`data:${((v=$[0])==null?void 0:v.type)||"image/jpeg"};base64,${e}`}},{type:"text",text:l}]}],max_tokens:4096}),signal:s.signal});if(clearTimeout(r),!a.ok){const S=await a.json().catch(()=>({}));throw new Error(`OpenAI API viga: ${a.status} - ${((m=S.error)==null?void 0:m.message)||a.statusText}`)}const p=await a.json();let T="";if((I=(M=(R=p.choices)==null?void 0:R[0])==null?void 0:M.message)!=null&&I.content?T=p.choices[0].message.content:(f=(o=p.choices)==null?void 0:o[0])!=null&&f.text?T=p.choices[0].text:typeof p.output_text=="string"?T=p.output_text:Array.isArray(p.output)&&p.output.length>0&&(T=p.output.map(S=>(S==null?void 0:S.content)||"").join("")),!T)throw new Error("Ei saanud OpenAI vastusest teksti");return T}else throw new Error("OCR pole seadistatud! Lisa OCR webhook URL ja secret v√µi OpenAI API v√µti seadetesse.")}catch(a){throw clearTimeout(r),a.name==="AbortError"?new Error("Timeout: OCR p√§ring v√µttis √ºle 30 sekundi"):a}}async function fe(){try{if(c(""),Y(!0),!$.length){L.trim()?c("‚úì Tekst on kleebitud. Vajuta 'Parsi tabelisse'."):c("‚ùå Pole faile ega teksti.");return}if((!(i!=null&&i.ocrWebhookUrl)||!(i!=null&&i.ocrSecret))&&!(i!=null&&i.openaiApiKey)){c("‚ùå OCR pole seadistatud! Lisa OCR webhook (URL + secret) v√µi OpenAI API v√µti seadetes!");return}if(!V.trim()){c("‚ùå M√§√§ra esmalt veerud!");return}c(k.usingOcr||"üîç OCR...");const e=await de($[0]),n=await ue(e);z(n),c("‚úÖ OCR valmis! Vajuta 'Parsi tabelisse'.")}catch(e){c("‚ùå Viga: "+((e==null?void 0:e.message)||String(e)))}finally{Y(!1)}}function pe(e){const n=e.split(/\r?\n/).map(o=>o.replace(/\t+/g,"  ").trim()).filter(Boolean);if(n.length===0){D([]),P([]),c("‚ùå T√ºhjus.");return}let d=0,l=-1;for(let o=0;o<Math.min(n.length,20);o++){const f=n[o].split(/\s{2,}|\t/).filter(Boolean),a=/\b(component|mark|qty|pcs|kogus|profile|length|weight|komponent)\b/i.test(n[o])?3:0,p=f.length+a;p>l&&(l=p,d=o)}const s=n[d].split(/\s{2,}|\t/).map(o=>he(o)).filter(Boolean),r=s.length>0?s:n[0].split(/\s{2,}|\t/).map((o,f)=>"Col"+(f+1)),x=[];let C=0;for(let o=0;o<n.length;o++){if(o===d)continue;const f=n[o].split(/\s{2,}|\t/);if(f.length<2){C++;continue}const a={};let p=!1,T=!1;for(let S=0;S<Math.min(f.length,r.length);S++){const Q=f[S].trim();a[r[S]]=Q,Q&&(p=!0),Q==="???"&&(T=!0)}T?(a._warning="‚ö†Ô∏è OCR ei suutnud lugeda",a._confidence=.5):f.length<r.length?(a._warning="‚ö†Ô∏è Puudulikud veerud",a._confidence=.6):p?a._confidence=.95:(a._warning="‚ö†Ô∏è T√ºhi rida",a._confidence=.3),x.push(a)}D(r),P(x);const h=r.map(o=>o.toLowerCase()),w=h.findIndex(o=>/\b(mark|component|item|part|komponent)\b/.test(o)),v=h.findIndex(o=>/\b(qty|pcs|kogus|tk|amount)\b/.test(o)),m=r.findIndex((o,f)=>f!==(w>=0?w:0)&&f!==(v>=0?v:r.length-1));X(r[w>=0?w:0]||""),Z(r[v>=0?v:r.length-1]||""),ee(r[m>=0?m:Math.min(2,r.length-1)]||"");const R=C>0?` ‚ö†Ô∏è ${C} rida j√§eti vahele.`:"",M=x.filter(o=>{var f;return(f=o._warning)==null?void 0:f.includes("ei suutnud")}).length,I=M>0?` ‚ö†Ô∏è ${M} lahtrit ???`:"";c(`‚úì Tabel valmis: ${x.length} rida.${R}${I}`)}function he(e){const n=e.replace(/\s+/g," ").trim();return n?n.replace(/No\./i,"No").replace(/Amount/i,"Qty").replace(/Pieces/i,"Pcs").replace(/Quantity/i,"Qty").replace(/[^\w\s.-]/g,"").trim():""}function me(e,n,d){P(l=>{var r;const s=[...l];return s[e]={...s[e],[n]:d},d&&d!=="???"&&((r=s[e]._warning)!=null&&r.includes("ei suutnud"))&&(delete s[e]._warning,s[e]._confidence=.95),s})}function ge(){const e={_confidence:1};e[b]="",e[j]="",E&&A&&(e[A]=""),P(n=>[...n,e])}function xe(e){P(n=>n.filter((d,l)=>l!==e))}async function be(){if(!b||!y.length){c("‚ùå Parsi esmalt tabel!");return}try{H(!0),c("üîç Otsin mudelist...");const e=K==null?void 0:K.viewer,n=y.map(h=>String(h[b]||"").trim()).filter(Boolean),d=[...new Set(n)],l=await(e==null?void 0:e.getObjects());if(!Array.isArray(l)){c("‚ùå API viga"),H(!1);return}const s=new Set;for(const h of l){const w=String(h.modelId),v=(h.objects||[]).map(m=>Number(m==null?void 0:m.id)).filter(m=>Number.isFinite(m));try{const m=await K.viewer.getObjectProperties(w,v);for(const R of m){const M=Array.isArray(R==null?void 0:R.properties)?R.properties:[];for(const I of M)for(const o of(I==null?void 0:I.properties)??[])if(/assembly[\/\s]?cast[_\s]?unit[_\s]?mark|^mark$|block/i.test(String(o==null?void 0:o.name))){const f=String((o==null?void 0:o.value)||(o==null?void 0:o.displayValue)||"").trim();d.some(a=>a.toLowerCase()===f.toLowerCase())&&s.add(f)}}}catch(m){console.warn(`Model ${w} error:`,m)}}const r=y.map(h=>{const w=String(h[b]||"").trim(),v=Array.from(s).some(m=>m.toLowerCase()===w.toLowerCase());return{...h,_foundInModel:v}});P(r);const x=r.filter(h=>h._foundInModel===!0).length,C=r.filter(h=>h._foundInModel===!1).length;c(`‚úì ${x} ‚úÖ leitud, ${C} ‚ùå ei leitud.`)}catch(e){c("‚ùå Viga: "+((e==null?void 0:e.message)||String(e)))}finally{H(!1)}}const ye=y.length,O=y.filter(e=>e._warning).length,_=y.filter(e=>e._foundInModel===!1).length,ae=g.useMemo(()=>{const e=[b,j];return E&&A&&A!==b&&A!==j&&e.push(A),e.filter(Boolean)},[b,j,A,E]),F=g.useMemo(()=>{const e=[];if(!b||!j)return e;for(const n of y){const d=String(n[b]||"").trim();if(!d)continue;const l=String(n[j]||"").replace(",",".").trim(),s=Math.max(1,Math.floor(Number(l)||0));for(let r=0;r<s;r++)e.push(d)}return e},[y,b,j]);function we(){if(!y.length){c("‚ùå Tabel on t√ºhi.");return}if(!b||!j){c("‚ùå Vali Mark ja Kogus veerud.");return}if(O>0){c(`‚ö†Ô∏è ${O} hoiatust. Paranda!`);return}if(_>0){c(`‚ö†Ô∏è ${_} ei leitud mudelist!`);return}U&&U(F,y,b,j),c("‚úÖ Kinnitatud: "+F.length+" kirjet.")}function je(){z(`Mark	Qty	Profile
B-101	3	HEA 200
C-205	2	HEB 300
PL-42	5	FL 10x200
BR-88	4	L 100x100x10`),re("Mark, Qty, Profile"),c("üìã N√§idis laaditud.")}return t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[t.jsxs("div",{children:[t.jsxs("label",{style:u.labelTop,children:["üìÅ ",k.uploadFiles||"Fail"]}),t.jsx("input",{ref:q,type:"file",accept:"image/*,application/pdf",onChange:e=>se(e.target.files),style:{fontSize:12,width:"100%"}})]}),t.jsxs("div",{children:[t.jsx("label",{style:u.labelTop,children:"üì∑ Pildista"}),t.jsx("input",{ref:W,type:"file",accept:"image/*",capture:"environment",onChange:e=>se(e.target.files),style:{display:"none"}}),t.jsx("button",{style:{...u.btn,width:"100%",background:"#d1fae5",borderColor:"#10b981"},onClick:()=>{var e;return(e=W.current)==null?void 0:e.click()},children:"üì∑ Kaamera"})]})]}),te&&t.jsx("div",{children:t.jsx("img",{src:te,alt:"Preview",style:{maxWidth:"100%",maxHeight:150,borderRadius:6,border:"1px solid #e5e7eb"}})}),t.jsxs("div",{children:[t.jsx("label",{style:u.labelTop,children:k.targetColumns||"Veerud"}),t.jsx("input",{value:V,onChange:e=>re(e.target.value),placeholder:"Mark, Qty, Profile",style:u.input}),t.jsx("div",{style:{fontSize:11,opacity:.6,marginTop:2},children:k.targetColumnsHint||"Kui veeru nimesid pole, kasuta numbreid: '1, 2, 3'"})]}),t.jsxs("div",{children:[t.jsx("label",{style:u.labelTop,children:k.orPasteText||"V√µi kleebi tekst"}),t.jsx("textarea",{style:{...u.textarea,height:100},value:L,onChange:e=>z(e.target.value),placeholder:k.pasteHint||"Tekst..."})]}),t.jsxs("div",{style:u.controls,children:[t.jsx("button",{style:{...u.btn,background:"#10b981",color:"#fff",borderColor:"#10b981"},disabled:J,onClick:fe,children:J?"‚è≥":k.runOcr||"üîç OCR"}),t.jsx("button",{style:u.btnGhost,onClick:je,children:"üìã N√§idis"}),t.jsx("button",{style:u.btn,onClick:()=>{if(!L.trim()){c("‚ùå Pole teksti.");return}pe(L)},children:k.parseToTable||"‚ö° Parsi"}),t.jsx("button",{style:u.btnGhost,onClick:()=>{z(""),P([]),D([]),G([]),ne(""),q.current&&(q.current.value=""),W.current&&(W.current.value=""),c("üóëÔ∏è T√ºhjendatud.")},children:"üóëÔ∏è"})]}),B&&t.jsx("div",{style:{...u.note,...B.includes("‚ùå")?{background:"#ffebee",borderColor:"#ef9a9a"}:B.includes("‚úÖ")||B.includes("‚úì")?{background:"#e8f5e9",borderColor:"#a5d6a7"}:{}},children:B})]}),y.length>0&&t.jsxs("div",{style:{border:"1px solid #edf0f4",borderRadius:8,padding:12,background:"#fafbfc"},children:[t.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8,flexWrap:"wrap",alignItems:"center"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:11,opacity:.7},children:k.markColumn||"Mark"}),t.jsx("select",{value:b,onChange:e=>X(e.target.value),style:{...u.input,width:120,padding:"4px 6px"},children:N.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:11,opacity:.7},children:k.qtyColumn||"Kogus"}),t.jsx("select",{value:j,onChange:e=>Z(e.target.value),style:{...u.input,width:120,padding:"4px 6px"},children:N.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("label",{style:{fontSize:12,display:"flex",alignItems:"center",gap:4},children:[t.jsx("input",{type:"checkbox",checked:E,onChange:e=>ce(e.target.checked)}),"3. veerg"]}),E&&t.jsx("select",{value:A,onChange:e=>ee(e.target.value),style:{...u.input,width:120,padding:"4px 6px"},children:N.filter(e=>e!==b&&e!==j).map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsx("button",{style:{...u.btn,background:"#7c3aed",color:"#fff",borderColor:"#7c3aed",marginLeft:"auto"},disabled:oe,onClick:be,children:oe?"üîç...":"üîç Otsi mudelist"})]}),t.jsxs("div",{style:{fontSize:11,opacity:.7,marginBottom:6},children:["Ridu: ",ye,O>0&&` ‚ö†Ô∏è ${O}`,_>0&&` ‚ùå ${_}`]}),t.jsx("div",{style:{overflow:"auto",maxHeight:400,border:"1px solid #e5e7eb",borderRadius:6},children:t.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:12},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{textAlign:"left",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0},children:"#"}),t.jsx("th",{style:{textAlign:"center",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0,width:40},children:"‚úì"}),ae.map(e=>t.jsx("th",{style:{textAlign:"left",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0},children:e},e)),t.jsx("th",{style:{textAlign:"center",borderBottom:"2px solid #e5e7eb",padding:"6px",background:"#f9fafb",position:"sticky",top:0,width:60},children:"-"})]})}),t.jsx("tbody",{children:y.map((e,n)=>{const d=!!e._warning,l=e._foundInModel===!1,s=e._foundInModel===!0,r=d?"#fef2f2":l?"#fff7ed":s?"#f0fdf4":n%2===0?"#fff":"#fafafa";return t.jsxs("tr",{style:{background:r},children:[t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6",textAlign:"center",opacity:.5,fontWeight:600},children:n+1}),t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6",textAlign:"center",fontSize:14},children:d?"‚ö†Ô∏è":l?"‚ùå":s?"‚úÖ":""}),ae.map(x=>t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6"},children:t.jsx("input",{value:e[x]||"",onChange:C=>me(n,x,C.target.value),style:{width:"100%",padding:"4px 6px",border:e[x]==="???"?"2px solid #f59e0b":"1px solid #e5e7eb",borderRadius:4,fontSize:12,outline:"none",background:e[x]==="???"?"#fffbeb":"transparent"},placeholder:e[x]==="???"?"???":""})},x)),t.jsx("td",{style:{padding:"4px 6px",borderBottom:"1px solid #f3f4f6",textAlign:"center"},children:t.jsx("button",{onClick:()=>xe(n),style:{...u.mini,background:"#fef2f2",borderColor:"#fca5a5"},children:"‚ùå"})})]},n)})})]})}),t.jsxs("div",{style:{display:"flex",gap:6,marginTop:8,alignItems:"center"},children:[t.jsx("button",{style:u.btnGhost,onClick:ge,children:"‚ûï Lisa"}),t.jsxs("div",{style:{marginLeft:"auto",fontSize:11,opacity:.7},children:["Otsingusse: ",t.jsx("strong",{children:F.length})]})]}),t.jsxs("div",{style:{marginTop:8},children:[t.jsx("button",{style:{...u.btnPrimary,width:"100%"},onClick:we,disabled:O>0||_>0,children:k.confirmAndSearch||`‚úÖ Kinnita (${F.length})`}),(O>0||_>0)&&t.jsx("div",{style:{marginTop:4,fontSize:11,color:"#dc2626"},children:"‚ö†Ô∏è Paranda punased/oran≈æid!"})]})]})]})}export{ve as default};
